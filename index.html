<!DOCTYPE html>
<html>
  <head>
    <title>Hedera NFT Richlist</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link
      href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@500&display=swap"
      rel="stylesheet"
    />
    <style>


      body {
        font-family: "Roboto Mono", monospace;
        margin: 0;
        padding: 0;
        height: 100vh;
        background-color: #2e43ff;
        background-image: -webkit-gradient(
          linear,
          left top,
          left bottom,
          from(#2e43ff),
          color-stop(40%, #2e43ff),
          to(#000000)
        );
        background-image: -o-linear-gradient(
          top,
          #2e43ff 0%,
          #2e43ff 40%,
          #000000 100%
        );
        background-image: linear-gradient(
          180deg,
          #2e43ff 0%,
          #2e43ff 40%,
          #000000 100%
        );
        overflow: hidden;
        display: -webkit-box;
        display: -ms-flexbox;
        display: flex;
        -webkit-box-pack: center;
        -ms-flex-pack: center;
        justify-content: center;
        -webkit-box-align: center;
        -ms-flex-align: center;
        align-items: center;
        -webkit-box-orient: vertical;
        -webkit-box-direction: normal;
        -ms-flex-direction: column;
        flex-direction: column;
        position: relative;
      }

      h1 {
        font-size: 2.5rem;
        text-transform: uppercase;
        letter-spacing: 5px;
        color: #fff;
        z-index: 2;
      }

      .input-wrapper {
        display: -webkit-box;
        display: -ms-flexbox;
        display: flex;
        margin-top: 30px;
        width: 60%;
        -webkit-box-pack: justify;
        -ms-flex-pack: justify;
        justify-content: space-between;
      }

      input,
      button {
        border: none;
        background: none;
        color: rgb(255, 255, 255);
        outline: none;
        border-bottom: 2px solid rgb(255, 255, 255);
        font-size: 1.2rem;
        z-index: 2;
      }

      ::-webkit-input-placeholder {
        color: rgb(255, 255, 255);
        opacity: 1;
      }

      ::-moz-placeholder {
        color: rgb(255, 255, 255);
        opacity: 1;
      }

      :-ms-input-placeholder {
        color: rgb(255, 255, 255);
        opacity: 1;
      }

      ::-ms-input-placeholder {
        color: rgb(255, 255, 255);
        opacity: 1;
      }

      ::placeholder {
        color: rgb(255, 255, 255);
        opacity: 1;
      }

      button {
        cursor: pointer;
        padding: 5px;
      }

      .balances {
        text-align: left;
        color: #fff;
        line-height: 30px;
        font-size: 1.5rem;
        margin-top: 20px;
        width: 60%;
        height: 400px;
        overflow: auto;
        border: 0.5px solid;
        border-color: #ffffff8b;
        padding: 20px;
        padding-left: 100px;
        border-radius: 20px;
        background-color: #ffffff24;
        -webkit-backdrop-filter: blur(5px);
        backdrop-filter: blur(5px);
        position: relative;
        z-index: 2;
      }

      .background-log {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        color: #2e43ff;
        font-size: 1rem;
        overflow: auto;
        z-index: 1;
        opacity: 1;
        line-height: 1.5;
      }

      .balances p,
      .background-log div {
        margin: 0;
      }

      .card-container {
        display: -webkit-box;
        display: -ms-flexbox;
        display: flex;
        -webkit-box-pack: justify;
        -ms-flex-pack: justify;
        justify-content: space-between;
        width: 60%;
        margin-top: 30px;
      }

      .card {
        background: rgba(255, 255, 255, 0.1);
        padding: 15px;
        border-radius: 10px;
        width: 30%;
        text-align: center;
        color: #fff;
        border: 0.5px solid;
        border-color: #ffffff8b;
        margin: 10px;
        margin-bottom: 0px;
        -webkit-backdrop-filter: blur(5px);
        backdrop-filter: blur(5px);
        z-index: 2;
      }

      .card p {
        font-size: 1.5rem;
      }
      .card h2 {
        margin: 10px;
      }
      @media (max-width: 900px) {
        h1 {
          font-size: 1.5rem;
        }
        .card p {
          font-size: 0.8rem;
        }
      
        .input-wrapper {
          width: 80%;
          margin-bottom: 10px;
          -webkit-box-orient: vertical;
          -webkit-box-direction: normal;
          -ms-flex-direction: column;
          flex-direction: column;
        }

        input,
        button {
          width: 100%;
          margin-bottom: 10px;
          font-size: 1rem;
        }

 
        .card-container {
          width: 100%;
          display: -webkit-box;
          display: -ms-flexbox;
          display: flex;
        }

        .card {
          width: 30%; /* Reduced width to fit three cards side by side */
          margin: 10px 1%; /* Adjusted margins for some spacing */
          font-size: 0.8rem; /* Reduced font size to fit in the smaller card */
          padding: 5px;
        }

        .card h2 {
          margin: 10px 0; /* Reduced margins to fit in the smaller card */
          font-size: .9rem; /* Reduced font size to fit in the smaller card */
        }

        .balances {
          font-size: 1.2rem;
          height: 600px; /* Increase if you want a longer scrolling list */
          padding: 10px;
          width: 90%;
          margin-bottom: 10px;
        }

        .card-container {
          width: 90%;
          margin-top: 30px;
        }

        .card-container,
        .balances {
          -webkit-box-sizing: border-box;
          box-sizing: border-box; /* This makes sure padding is included in the width */
        }

        button {
          margin-top: 15px;
        }
      }
    </style>
  </head>
  <body>
    <h1>NFT Richlist</h1>
    <div class="input-wrapper">
      <input type="text" id="tokenID" placeholder="Enter token ID..." />
      <button onclick="fetchTokenBalances()">Fetch</button>
    </div>

    <div class="card-container">
      <div class="card" id="unique-holder-percent-card">
        <h2>Unique Holders</h2>
        <p>...</p>
      </div>
      <div class="card" id="total-distribution-percent-card">
        <h2>Total Distribution</h2>
        <p>...</p>
      </div>
      <div class="card" id="average-holdings-card">
        <h2>Average Holdings</h2>
        <p>...</p>
      </div>
    </div>

    <div class="balances" id="balances"></div>
    <div class="background-log" id="backgroundLog"></div>

    <script>
      async function getBalances(urlToFetch) {
        try {
          // Fetch the balances
          const response = await fetch(urlToFetch);
          const data = await response.json();

          // Print each response to the background as it comes
          const backgroundLogDiv = document.getElementById("backgroundLog");
          const backgroundDiv = document.createElement("div");
          backgroundDiv.textContent = JSON.stringify(data, null, 2);
          // Insert each new log at the top of the backgroundLogDiv
          backgroundLogDiv.insertBefore(
            backgroundDiv,
            backgroundLogDiv.firstChild
          );

          // Return the balances and the next link (if it exists)
          const nextLink = data.links && data.links.next;
          const balances = data.balances;

          if (nextLink) {
            const nextUrl = new URL(nextLink, urlToFetch).href;
            const nextBalances = await getBalances(nextUrl);
            return balances.concat(nextBalances);
          } else {
            return balances;
          }
        } catch (error) {
          // Log and throw the error
          console.error("Failed to fetch the balances:", error);
          throw error;
        }
      }

      function calcUniqueHoldersPercentage(balances) {
        return (
          (balances.length /
            balances.reduce((sum, balance) => sum + balance.balance, 0)) *
          100
        ).toFixed(2);
      }

      function calcAverageHoldings(balances) {
        return (
          balances.reduce((sum, balance) => sum + balance.balance, 0) /
          balances.length
        ).toFixed(2);
      }

      async function fetchTokenBalances() {
        // Change the h1 content to "Searching Mirror Node"
        const h1 = document.getElementsByTagName("h1")[0];
        h1.textContent = "Searching";

        // Fetch the balances
        const tokenID = document.getElementById("tokenID").value;
        const balances = await getBalances(
          `https://mainnet-public.mirrornode.hedera.com/api/v1/tokens/${tokenID}/balances`
        );

        // Remove balances with zero and sort in descending order
        const filteredBalances = balances
          .filter((balance) => balance.balance > 0)
          .sort((a, b) => b.balance - a.balance);

        // Calculate metrics and update the cards
        document
          .getElementById("unique-holder-percent-card")
          .querySelector("p").textContent = `${calcUniqueHoldersPercentage(
          filteredBalances
        )}%`;
        document
          .getElementById("total-distribution-percent-card")
          .querySelector("p").textContent = "100%";
        document
          .getElementById("average-holdings-card")
          .querySelector("p").textContent =
          calcAverageHoldings(filteredBalances);

        // Display the balances
        const balancesDiv = document.getElementById("balances");
        balancesDiv.innerHTML = "";

        for (let balance of filteredBalances) {
          const div = document.createElement("div");
          div.className = "balance";
          div.textContent = `${balance.account} - Owns ${balance.balance}`;
          balancesDiv.appendChild(div);
        }

        // Change the h1 content back to "NFT Richlist"
        h1.textContent = "NFT Richlist";
      }
    </script>
  </body>
</html>
